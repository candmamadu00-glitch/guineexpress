<!DOCTYPE html>
<html lang="pt">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="cici.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o - Guineexpress</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0a1931">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Guineexpress">

<link rel="icon" type="image/png" href="/logo.png">
<link rel="apple-touch-icon" href="/logo.png">

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('App registrado'))
                .catch(err => console.log('Erro PWA', err));
        });
    }
</script>
</head>
<body>

    <nav class="dashboard-nav">
        <div style="font-weight:bold; font-size:18px;">
            GUINEEXPRESS 
            <span id="user-role-display" style="font-size:12px; font-weight:normal; opacity:0.8;"></span>
        </div>
        <div class="nav-links">
            <button onclick="showSection('dashboard-home')" class="nav-btn"><i class="fas fa-chart-line"></i> Vis√£o Geral</button>
            <button onclick="exportSmartPDF()" class="btn" style="background-color: #dc3545; color: white;"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
            <button onclick="showSection('expenses-view')">üí∏ Despesas</button>
            <button onclick="showSection('logs-view')" style="color: #ffc107;"><i class="fas fa-shield-alt"></i> Auditoria</button>
            <button onclick="showSection('employees-view'); loadEmployees();"><i class="fas fa-users-cog"></i> Funcion√°rios</button>
            <button onclick="showSection('shipments-view')"><i class="fas fa-shipping-fast"></i> Embarques</button>
            <button onclick="showSection('orders-view')"><i class="fas fa-box"></i> Encomendas</button>
            <button onclick="openBroadcastModal()" class="btn" style="background-color: #6f42c1; color: white; margin-right: 10px;">üì¢ Novo Comunicado</button>
            <button onclick="startScanner()" class="btn" style="background: #ffc107; color: #000; margin-right: 10px;"><i class="fas fa-qrcode"></i> Escanear</button>
            <button onclick="showSection('history-view')" class="nav-btn"><i class="fas fa-history"></i> Hist√≥rico</button>
            <button onclick="showSection('box-view')">üì¶ Box</button>
            <button onclick="showSection('labels-view')" id="btn-labels" class="nav-btn"><i class="fas fa-tags"></i> Etiquetas</button>
            <button onclick="showSection('billing-view')">üí≤ Financeiro</button> 
            <button onclick="showSection('schedule-view')">üìÖ Agendamentos</button>
            <button onclick="showSection('receipts-view')"><i class="fas fa-file-invoice"></i> Recibos</button>
            <button onclick="showSection('price-section')">üí∞ Pre√ßo</button>
            <button onclick="showSection('videos-section')">üé• V√≠deos</button>
            <button onclick="showSection('clients-view')"><i class="fas fa-users"></i> Clientes</button>
            <button onclick="showSection('logs-view'); loadAccessLogs()" class="btn-menu"><i class="fas fa-user-shield"></i> Hist√≥rico de Acessos</button>
            <button onclick="logout()" style="color:#ff4d4d;"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </nav>

    <div class="container">
        
        <section id="schedule-view" class="hidden">
            <div class="card" style="margin-bottom: 20px;">
                <h3>Criar Vagas de Atendimento</h3>
                <form onsubmit="createAvailability(event)" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="date" id="sched-date" class="form-control" required>
                    <input type="time" id="sched-start" class="form-control" required>
                    <input type="time" id="sched-end" class="form-control" required>
                    <input type="number" id="sched-slots" class="form-control" placeholder="Qtd Vagas" style="width:100px;" required>
                    <button type="submit" class="btn-primary" style="width:auto;">Abrir Vagas</button>
                </form>
            </div>
            <div class="card">
                <h3>Solicita√ß√µes de Agendamento</h3>
                <table class="data-table">
                    <thead>
                        <tr><th>Data</th><th>Hor√°rio</th><th>Cliente</th><th>Tel</th><th>Status</th><th>A√ß√£o</th></tr>
                    </thead>
                    <tbody id="admin-schedule-list"></tbody>
                </table>
            </div>
        </section>

        <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
            <button onclick="forceBackup()" class="btn" style="background: #28a745; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-radius: 50px; padding: 15px 25px;">
                <i class="fas fa-shield-alt"></i> Backup Agora
            </button>
        </div>

        <section id="dashboard-home">
            <div class="header-flex">
                <h2>üìä Vis√£o Geral do Neg√≥cio</h2>
                <button onclick="loadDashboardStats()" class="btn btn-primary" style="width: auto;">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #d4af37;"><i class="fas fa-coins"></i></div>
                    <div class="kpi-info">
                        <h3>Faturamento Total</h3>
                        <p id="kpi-revenue">R$ 0,00</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #0a1931;"><i class="fas fa-weight-hanging"></i></div>
                    <div class="kpi-info">
                        <h3>Peso Total</h3>
                        <p id="kpi-weight">0 kg</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #28a745;"><i class="fas fa-box-open"></i></div>
                    <div class="kpi-info">
                        <h3>Encomendas</h3>
                        <p id="kpi-orders">0</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #17a2b8;"><i class="fas fa-users"></i></div>
                    <div class="kpi-info">
                        <h3>Clientes Ativos</h3>
                        <p id="kpi-clients">0</p>
                    </div>
                </div>
            </div>

            <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;">
                <div class="chart-container">
                    <h3>üìà Movimenta√ß√£o Financeira (√öltimos 6 Meses)</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>üì¶ Status das Encomendas</h3>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="orders-view">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3>Gest√£o de Encomendas</h3>
            
            <div style="display:flex; gap: 10px;">
                
                <button class="btn" onclick="exportOrdersToExcel()" style="background-color: #217346; color: white;">
                    <i class="fas fa-file-excel"></i> Baixar Excel
                </button>

                <button class="btn btn-accent" onclick="prepareNewOrder()" style="width: auto;">
                    + Nova Encomenda
                </button>
            </div>
        </div>

                <div style="margin: 15px 0; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #888;"></i>
                    <input type="text" id="search-orders" onkeyup="searchTable('search-orders', 'orders-list')" 
                           placeholder="Buscar por c√≥digo, cliente ou status..." 
                           style="width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>

                <table class="data-table">
                    <thead>
                        <tr><th>C√≥digo</th><th>Cliente</th><th>Descri√ß√£o</th><th>Peso</th><th>Status</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="orders-list"></tbody>
                </table>
            </div>

            <div id="modal-order" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-order-title">üì¶ Nova Encomenda</h3>
                        <button class="btn-close" onclick="closeModal('modal-order')">&times;</button>
                    </div>
                    
                    <form id="new-order-form" onsubmit="handleOrderSubmit(event)">
                        <input type="hidden" id="editing-order-id">

                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="order-client-select" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label>C√≥digo</label>
                            <input type="text" id="order-code" class="form-control" placeholder="Ex: ENC-1234" required>
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" id="order-desc" class="form-control" placeholder="Ex: Roupas">
                        </div>
                        <div class="form-group">
                            <label>Peso (Kg)</label>
                            <input type="number" id="order-weight" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="order-status" class="form-control">
                                <option value="Processando">Processando</option>
                                <option value="Pendente Pagamento">Pendente Pagamento</option>
                                <option value="Pago">Pago</option>
                                <option value="Enviado">Enviado</option>
                                <option value="Entregue">Entregue</option>
                            </select>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn" onclick="closeModal('modal-order')" style="background:#ccc; width:auto;">Cancelar</button>
                            <button type="submit" class="btn btn-primary" style="width:auto;">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="clients-view" class="hidden">
            <div class="card">
                <h3>Base de Clientes</h3>
                <table class="data-table">
                    <thead>
                        <tr><th>Foto</th><th>Nome</th><th>Email</th><th>Tel</th><th>Pa√≠s</th><th>Status</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="clients-list"></tbody>
                </table>
            </div>
        </section>
     <section id="logs-view" class="hidden">
    <h2>üõ°Ô∏è Monitoramento de Seguran√ßa</h2>
    <p>Veja quem acessou o sistema, tentativas de invas√£o e dispositivos usados.</p>

    <div class="table-container" style="margin-top: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <button onclick="loadAccessLogs()" class="btn" style="background: #6c757d; color: white; margin-bottom: 15px;">
            <i class="fas fa-sync-alt"></i> Atualizar Lista
        </button>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f4f4f4; text-align: left;">
                    <th style="padding: 10px;">Data/Hora</th>
                    <th style="padding: 10px;">Quem (Input)</th>
                    <th style="padding: 10px;">Status</th>
                    <th style="padding: 10px;">Dispositivo</th>
                    <th style="padding: 10px;">IP</th>
                    <th style="padding: 10px;">Detalhe</th>
                </tr>
            </thead>
            <tbody id="logs-table-body">
                </tbody>
        </table>
    </div>
</section>
        <section id="box-view" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Gest√£o de Box</h3>
                    <button onclick="openModal('modal-box')" class="btn btn-primary"><i class="fas fa-box-open"></i> Novo Box</button>
                </div>
                <div style="margin: 15px 0; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #888;"></i>
                    <input type="text" id="search-box" onkeyup="searchTable('search-box', 'box-table-body')" 
                           placeholder="Buscar Box..." style="width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr><th>N¬∞ Box</th><th>Cliente</th><th>Ref. Encomenda</th><th>Peso</th><th>Valor Estimado</th><th>Produtos</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="box-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="modal-box" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üì¶ Criar Novo Box</h3>
                        <button class="btn-close" onclick="closeModal('modal-box')">&times;</button>
                    </div>
                    <form id="new-box-form" onsubmit="createBox(event)">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="box-client-select" class="form-control" required onchange="loadClientOrdersInBox(this.value)"></select>
                        </div>
                        <div class="form-group">
                            <label>Vincular Encomenda</label>
                            <select id="box-order-select" class="form-control" disabled onchange="autoFillBoxData(this)">
                                <option value="">Selecione o Cliente Primeiro...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero Box</label>
                            <input type="text" id="box-code" class="form-control" required placeholder="Ex: BOX-001">
                        </div>
                        <div class="form-group">
                            <label>Produtos</label>
                            <textarea id="box-products" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Valor (opcional)</label>
                            <input type="number" id="box-amount" class="form-control" step="0.01">
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn" onclick="closeModal('modal-box')" style="background:#ccc; width:auto;">Cancelar</button>
                            <button type="submit" class="btn btn-primary" style="width:auto;">Criar</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="billing-view" class="hidden">
            <div class="card" id="admin-billing-panel" style="background: #e8f0fe; border-left: 5px solid #0a1931;">
                <h3><i class="fas fa-file-invoice-dollar"></i> Gerar Nova Cobran√ßa</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">Selecione um cliente e um box para gerar o QR Code Pix e link de pagamento.</p>
                
                <form onsubmit="createInvoice(event)" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                    <div class="form-group">
                        <label>1. Selecione o Cliente</label>
                        <select id="bill-client-select" class="form-control" onchange="loadClientBoxesForBilling(this.value)" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>2. Selecione o Box</label>
                        <select id="bill-box-select" class="form-control" onchange="calculateBillAmount(this)" required disabled>
                            <option value="">Selecione Cliente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valor Total (Calculado)</label>
                        <input type="number" id="bill-amount" class="form-control" step="0.01" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="height: 45px; margin-bottom: 2px; font-weight:bold;">
                        <i class="fas fa-qrcode"></i> Gerar Fatura
                    </button>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Status de Pagamentos</h3>
                    <button onclick="loadInvoices()" class="btn-secondary" style="width:auto;">üîÑ Atualizar Lista</button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Box Ref</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="invoices-list"></tbody>
                </table>
            </div>
        </section>

        <section id="expenses-view" class="hidden">
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="kpi-card" style="border-left-color: #28a745;">
                    <div class="kpi-info">
                        <h3>Entradas (Faturamento)</h3>
                        <p id="fin-revenue" style="color: #28a745;">R$ 0,00</p>
                    </div>
                </div>
                <div class="kpi-card" style="border-left-color: #dc3545;">
                    <div class="kpi-info">
                        <h3>Sa√≠das (Despesas)</h3>
                        <p id="fin-expenses" style="color: #dc3545;">R$ 0,00</p>
                    </div>
                </div>
                <div class="kpi-card" style="border-left-color: #0a1931;">
                    <div class="kpi-info">
                        <h3>Lucro L√≠quido</h3>
                        <p id="fin-profit" style="color: #0a1931;">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Cadastrar Nova Despesa</h3>
                <form onsubmit="addExpense(event)" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <input type="text" id="exp-desc" class="form-control" placeholder="Ex: Aluguel Galp√£o" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="exp-cat" class="form-control">
                            <option value="Operacional">Operacional</option>
                            <option value="Frete">Frete A√©reo/Mar√≠timo</option>
                            <option value="Sal√°rio">Sal√°rio/Pessoal</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valor (R$)</label>
                        <input type="number" id="exp-amount" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="exp-date" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="background: #dc3545; height: 45px; margin-bottom: 2px;">
                        <i class="fas fa-minus-circle"></i> Registrar Sa√≠da
                    </button>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Hist√≥rico de Gastos</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-list"></tbody>
                </table>
            </div>
        </section>

        <section id="logs-view" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>üõ°Ô∏è Auditoria e Seguran√ßa</h3>
                    <button onclick="loadSystemLogs()" class="btn-secondary" style="font-size: 12px;">üîÑ Atualizar</button>
                </div>
                <p style="color:#666; font-size:13px; margin-bottom:15px;">Monitoramento de a√ß√µes sens√≠veis no sistema (√öltimos 100 registros).</p>
                
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usu√°rio</th>
                                <th>A√ß√£o</th>
                                <th>Detalhes</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="logs-list"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="shipments-view" class="hidden">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                
                <div>
                    <div class="card">
                        <h3>‚úàÔ∏è Gerenciar Embarques</h3>
                        <form onsubmit="createShipment(event)" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end;">
                            <div class="form-group">
                                <label>C√≥digo do Lote</label>
                                <input type="text" id="ship-code" class="form-control" placeholder="Ex: LOTE-500" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="ship-type" class="form-control">
                                    <option value="A√©reo">A√©reo</option>
                                    <option value="Mar√≠timo">Mar√≠timo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data Sa√≠da</label>
                                <input type="date" id="ship-date" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="height: 45px; margin-bottom: 2px;">Criar</button>
                        </form>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Lote</th>
                                    <th>Tipo</th>
                                    <th>Sa√≠da</th>
                                    <th>Qtd. Caixas</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="shipments-list"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="background: #fff3cd; border: 1px solid #ffeeba;">
                    <h3>üì¶ Caixas Pendentes</h3>
                    <p style="font-size: 12px; margin-bottom: 10px;">Selecione um lote abaixo e clique na caixa para adicionar.</p>
                    
                    <div class="form-group">
                        <label>Selecionar Lote de Destino:</label>
                        <select id="target-shipment" class="form-control" style="background: white;">
                            <option value="">-- Escolha um Lote --</option>
                        </select>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                        <ul id="pending-boxes-list" style="list-style: none; padding: 0;">
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="labels-view" class="hidden">
            <div class="header-flex">
                <h2>üè∑Ô∏è Gerador de Etiquetas</h2>
                <div>
                    <button onclick="printSelectedLabels()" class="btn btn-primary" style="background: #d4af37; color: #000; font-weight: bold;">
                        <i class="fas fa-print"></i> Imprimir Selecionadas
                    </button>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <input type="text" id="label-search" onkeyup="filterLabels()" placeholder="Pesquisar por cliente ou c√≥digo..." class="form-control">
            </div>

            <div class="card">
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" onclick="toggleAllLabels(this)"></th>
                                <th>Data</th>
                                <th>C√≥digo</th>
                                <th>Cliente</th>
                                <th>Descri√ß√£o</th>
                                <th>Peso</th>
                            </tr>
                        </thead>
                        <tbody id="labels-list"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="price-section" class="hidden">
            <div class="card">
                <h3>üí∞ Defini√ß√£o de Pre√ßo por Kg</h3>
                <p>Defina o valor base cobrado por cada Quilograma para o c√°lculo autom√°tico.</p>
                <div class="form-group">
                    <label>Pre√ßo por Kg (R$):</label>
                    <input type="number" id="price-input" class="form-control" step="0.01" placeholder="Ex: 5.50">
                </div>
                <button onclick="savePrice()" class="btn btn-primary" style="width:auto;">Salvar Novo Pre√ßo</button>
            </div>
        </section>

        <section id="videos-section" class="hidden">
            <div class="card">
                <h3>üé• Nova Grava√ß√£o</h3>
                
                <div class="form-group">
                    <label>1. Selecione a Encomenda para vincular:</label>
                    <select id="video-client-select" class="form-control" onchange="checkVideoPermission()">
                        <option value="">Carregando lista...</option>
                    </select>
                </div>

                <div id="video-order-info" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <small>Resumo: <span id="info-desc" style="font-weight:bold;">-</span></small>
                </div>

                <button id="btn-open-fullscreen" onclick="openFullscreenCamera()" class="btn-primary" style="width: 100%; padding: 15px; font-size: 18px; background: #2c3e50;" disabled>
                    <i class="fas fa-camera"></i> ABRIR C√ÇMERA
                </button>
            </div>

            <div id="fullscreen-camera-overlay" class="hidden">
                
                <button onclick="closeFullscreenCamera()" style="position: absolute; top: 20px; right: 20px; z-index: 10001; background: none; border: none; color: white; font-size: 30px;">&times;</button>
                
                <video id="camera-feed" autoplay playsinline muted></video>
                <video id="video-preview" controls style="display: none;"></video>

                <div class="camera-floating-controls">
                    
                    <div id="record-ui">
                        <p id="recording-timer" class="hidden">00:00</p>
                        
                        <div style="display: flex; align-items: center; gap: 30px;">
                            <button onclick="switchCamera()" class="btn-icon">
                                <i class="fas fa-sync-alt"></i>
                            </button>

                            <button id="btn-start-rec" onclick="startRecording()" class="btn-record-circle"></button>
                            
                            <button id="btn-stop-rec" onclick="stopRecording()" class="btn-stop-square hidden"></button>
                            
                            <div style="width: 40px;"></div> 
                        </div>
                    </div>

                    <div id="upload-ui" class="hidden" style="width: 100%; padding: 20px;">
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="retakeVideo()" class="btn-secondary" style="background: white; color: black; border: none;">Descartar</button>
                            <button onclick="confirmUpload()" class="btn-primary" style="background: #28a745; border: none; flex: 1;">Enviar V√≠deo üöÄ</button>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>Hist√≥rico de V√≠deos Enviados</h3>
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Cliente</th><th>Data</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="admin-video-list"></tbody>
                </table>
            </div>
        </section>

        <section id="receipts-view" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3><i class="fas fa-file-invoice"></i> Recibos e Comprovantes</h3>
                </div>
                <p style="color:#666; font-size:13px; margin-bottom:15px;">
                    Recibos gerados automaticamente a partir das Boxes cadastradas.
                </p>

                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>N¬∞ Box</th>
                                <th id="rec-col-client">Cliente</th> <th>Conte√∫do</th>
                                <th>Peso</th>
                                <th>Valor</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="receipts-list"></tbody>
                    </table>
                </div>
            </div>
        </section>
     
        <section id="employees-view" class="hidden">
            <div class="header-flex">
                <h2>üë∑ Gest√£o de Funcion√°rios</h2>
            </div>

            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="employees-list"></tbody>
                </table>
                <p style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    * Funcion√°rios desativados perdem acesso imediato ao sistema.
                </p>
            </div>
        </section>
 <div id="broadcast-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h3>üì¢ Enviar para Todos os Clientes</h3>
            <button class="btn-close" onclick="closeModal('broadcast-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                Isso enviar√° um e-mail para <b>todos</b> os clientes cadastrados. Use com sabedoria!
            </p>
            <div class="form-group">
                <label>Assunto</label>
                <input type="text" id="broadcast-subject" class="form-control" placeholder="Ex: Atraso no voo TP-202">
            </div>
            <div class="form-group">
                <label>Mensagem</label>
                <textarea id="broadcast-message" class="form-control" rows="5" placeholder="Escreva o comunicado aqui..."></textarea>
            </div>
            <button onclick="sendBroadcast()" class="btn btn-primary" style="width: 100%;">ENVIAR AGORA üöÄ</button>
        </div>
    </div>
</div>
        <section id="history-view" class="hidden">
            <div class="header-flex">
                <h2>üìú Hist√≥rico Global de Envios</h2>
                <input type="text" id="history-search" onkeyup="filterHistory()" placeholder="Filtrar por c√≥digo ou nome..." class="form-control" style="max-width: 300px;"> 
            </div>

            <div class="card-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>C√≥digo</th>
                            <th id="hist-col-client">Cliente</th> 
                            <th>Descri√ß√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </section>
        
<div id="print-area" class="hidden-print-area"></div>

    <div id="scanner-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3>üì± Leitor de Encomendas</h3>
            <p>Aponte a c√¢mera para o QR Code da etiqueta</p>
            <div id="reader" style="width: 100%; border-radius: 8px; overflow: hidden;"></div>
            <div class="modal-actions" style="justify-content: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="stopScanner()">Fechar Leitor</button>
            </div>
        </div>
    </div>

    <div id="delivery-photo-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center; max-width: 400px;">
        <h3>üì∏ Comprovante de Entrega</h3>
        <p>Tire uma foto do pacote com o cliente.</p>
        
        <div style="position: relative; width: 100%; height: 250px; background: #000; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
            <video id="delivery-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            <canvas id="delivery-canvas" style="display:none;"></canvas>
            <img id="delivery-preview" style="display:none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
        </div>

        <div class="modal-actions" style="justify-content: center; gap: 10px;">
            <button class="btn btn-secondary" onclick="DeliveryProof.close()">Cancelar</button>
            <button id="btn-snap-photo" class="btn btn-primary" onclick="DeliveryProof.snap()">üì∑ Tirar Foto</button>
            <button id="btn-confirm-delivery" class="btn btn-success hidden" onclick="DeliveryProof.confirm()">‚úÖ Confirmar Entrega</button>
        </div>
    </div>
</div>

<div id="view-proof-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
    <div class="modal-content" style="background: transparent; box-shadow: none; text-align: center;">
        <img id="proof-image-full" src="" style="max-width: 100%; border-radius: 10px; border: 4px solid white;">
        <br>
        <button class="btn btn-secondary" style="margin-top: 10px;">Fechar</button>
    </div>
</div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { 
            if(typeof initDashboard === 'function') initDashboard(); 
            
            // Inicia o carregamento dos clientes para a aba financeira
            if(typeof loadClientsForBilling === 'function') {
                loadClientsForBilling();
                if(typeof loadDashboardStats === 'function') loadDashboardStats();
            }
        });
        
    </script>
    <script>
    window.exportSmartPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 1. Detecta qual aba est√° vis√≠vel e define qual tabela usar
        let activeTableId = '';
        let title = '';
        let columns = [];

        // Verifica se a aba de Encomendas est√° vis√≠vel
        const ordersView = document.getElementById('orders-view');
        const financeView = document.getElementById('finance-view');

        if (ordersView && !ordersView.classList.contains('hidden')) {
            activeTableId = 'orders-list';
            title = 'Relat√≥rio Geral de Encomendas';
            // Cabe√ßalhos para Encomendas
            columns = [['C√≥digo', 'Cliente', 'Desc.', 'Peso', 'Status', 'Data']];
        } 
        else if (financeView && !financeView.classList.contains('hidden')) {
            activeTableId = 'finance-list';
            title = 'Relat√≥rio Financeiro Individual';
            // Cabe√ßalhos para Financeiro
            columns = [['Cliente / Encomenda', 'Peso (kg)', 'Valor (XOF)', 'Status']];
        } else {
            alert("‚ö†Ô∏è Navegue para a aba 'Encomendas' ou 'Financeiro' antes de gerar o PDF.");
            return;
        }

        // 2. Busca os dados da tabela ativa
        let tableBody = document.getElementById(activeTableId);
        
        if (!tableBody || tableBody.rows.length === 0) {
            alert(`‚ö†Ô∏è A tabela de ${title.split(' ')[1]} est√° vazia na tela!\n\nüëâ DICA: Se for Financeiro, selecione um cliente primeiro.`);
            return;
        }

        // 3. Monta o PDF
        doc.setFillColor(10, 25, 49); // Azul Guineexpress
        doc.rect(0, 0, 210, 20, 'F');
        
        doc.setFontSize(16);
        doc.setTextColor(255, 255, 255);
        doc.text(`Guineexpress - ${title}`, 14, 13);

        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text("Gerado em: " + new Date().toLocaleString('pt-BR'), 14, 30);

        // Extrai dados das linhas (Ignorando bot√µes)
        let rows = [];
        for (let row of tableBody.rows) {
            let rowData = [];
            for (let i = 0; i < row.cells.length; i++) {
                let cellText = row.cells[i].innerText.trim();
                // Pula coluna de A√ß√µes (bot√µes) se for a √∫ltima
                if (activeTableId === 'orders-list' && i === row.cells.length - 1) continue;
                rowData.push(cellText);
            }
            rows.push(rowData);
        }

        doc.autoTable({
            head: columns,
            body: rows,
            startY: 35,
            theme: 'striped',
            headStyles: { fillColor: [10, 25, 49] },
            styles: { fontSize: 9 }
        });

        doc.save(`Guineexpress_Relatorio_${Date.now()}.pdf`);
    }
</script>

    <script src="cici.js"></script>
</body>
</html>