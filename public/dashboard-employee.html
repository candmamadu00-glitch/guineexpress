<!DOCTYPE html>
<html lang="pt">
<head>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="cici.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcion√°rio - Guineexpress</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0a1931">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Guineexpress">

<link rel="icon" type="image/png" href="/logo.png">
<link rel="apple-touch-icon" href="/logo.png">

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('App registrado'))
                .catch(err => console.log('Erro PWA', err));
        });
    }
</script>
</head>
<body>

    <nav class="dashboard-nav" style="background: #2c3e50;">
        <div style="font-weight:bold; font-size:18px;">
            GUINEEXPRESS 
            <span style="font-size:12px; font-weight:normal; opacity:0.8;">| FUNCION√ÅRIO</span>
        </div>
        <div class="nav-links">
            <button onclick="showSection('finances-view'); loadFinances();" class="nav-btn"><i class="fas fa-file-invoice-dollar"></i> üí∏Faturas</button>
            <button onclick="showSection('orders-view')"><i class="fas fa-box"></i> Encomendas</button>
            <button onclick="startScanner()" class="btn" style="background: #ffc107; color: #000; margin-right: 10px;"><i class="fas fa-qrcode"></i> Escanear</button>
            <button onclick="showSection('history-view')" class="nav-btn"><i class="fas fa-history"></i> Hist√≥rico</button>
            <button onclick="showSection('box-view')">üì¶ Box</button>
            <button onclick="openBroadcastModal()" class="btn" style="background-color: #6f42c1; color: white; margin-right: 10px;">üì¢ Novo Comunicado</button>
            <button onclick="showSection('labels-view')" id="btn-labels" class="nav-btn"><i class="fas fa-tags"></i> Etiquetas</button>
            <button onclick="showSection('billing-view')">üí≤ Status Pagto</button> 
            <button onclick="showSection('schedule-view')">üìÖ Agendamentos</button>
            <button onclick="showSection('videos-section')">üé• V√≠deos</button>
            <button onclick="showSection('clients-view')"><i class="fas fa-users"></i> Clientes</button>
            <button onclick="logout()" style="color:#ff4d4d;"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </nav>

    <div class="container">
        
        <section id="schedule-view" class="hidden">
            <div class="card" style="margin-bottom: 20px;">
                <h3>Criar Vagas de Atendimento</h3>
                <form onsubmit="createAvailability(event)" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="date" id="sched-date" class="form-control" required>
                    <input type="time" id="sched-start" class="form-control" required>
                    <input type="time" id="sched-end" class="form-control" required>
                    <input type="number" id="sched-slots" class="form-control" placeholder="Qtd Vagas" style="width:100px;" required>
                    <button type="submit" class="btn-primary" style="width:auto;">Abrir Vagas</button>
                </form>
            </div>

            <div class="card">
                <h3>Agendamentos do Dia</h3>
                <table class="data-table">
                    <thead>
                        <tr><th>Data</th><th>Hor√°rio</th><th>Cliente</th><th>Tel</th><th>Status</th><th>A√ß√£o</th></tr>
                    </thead>
                    <tbody id="admin-schedule-list"></tbody>
                </table>
            </div>
        </section>

         <section id="orders-view">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Gest√£o de Encomendas</h3>
            <button class="btn btn-accent" onclick="prepareNewOrder()" style="width: auto;">
                + Nova Encomenda
            </button>
        </div>

        <div style="margin: 15px 0; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #888;"></i>
            <input type="text" id="search-orders" onkeyup="searchTable('search-orders', 'orders-list')" 
                   placeholder="Buscar por c√≥digo, cliente ou status..." 
                   style="width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        </div>

        <table class="data-table">
            <thead>
                <tr><th>C√≥digo</th><th>Cliente</th><th>Descri√ß√£o</th><th>Peso</th><th>Status</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="orders-list"></tbody>
        </table>
    </div>

    <div id="modal-order" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-order-title">üì¶ Nova Encomenda</h3>
                <button class="btn-close" onclick="closeModal('modal-order')">&times;</button>
            </div>
            
            <form id="new-order-form" onsubmit="handleOrderSubmit(event)">
                <input type="hidden" id="editing-order-id">

                <div class="form-group">
                    <label>Cliente</label>
                    <select id="order-client-select" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label>C√≥digo</label>
                    <input type="text" id="order-code" class="form-control" placeholder="Ex: ENC-1234" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="order-desc" class="form-control" placeholder="Ex: Roupas">
                </div>
                <div class="form-group">
                    <label>Peso (Kg)</label>
                    <input type="number" id="order-weight" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="order-status" class="form-control">
                        <option value="Processando">Processando</option>
                        <option value="Pendente Pagamento">Pendente Pagamento</option>
                        <option value="Pago">Pago</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregue">Entregue</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal('modal-order')" style="background:#ccc; width:auto;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="width:auto;">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</section>

        <section id="clients-view" class="hidden">
            <div class="card">
                <h3>Base de Clientes</h3>
                <table class="data-table">
                    <thead><tr><th>Foto</th><th>Nome</th><th>Email</th><th>Tel</th><th>Pa√≠s</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="clients-list"></tbody>
                </table>
            </div>
        </section>

        <section id="box-view" class="hidden">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Gest√£o de Box</h3>
              <button onclick="openModal('modal-box')" class="btn btn-primary"><i class="fas fa-box-open"></i> Novo Box</button>
                </div>
                <div style="margin: 15px 0; position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #888;"></i>
                    <input type="text" id="search-box" onkeyup="searchTable('search-box', 'box-table-body')" placeholder="Buscar Box..." style="width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead><tr><th>N¬∞ Box</th><th>Cliente</th><th>Ref. Encomenda</th><th>Peso</th><th>Status</th><th>Produtos</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="box-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="modal-box" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header"><h3>üì¶ Criar Novo Box</h3><button class="btn-close" onclick="closeModal('modal-box')">&times;</button></div>
                    <form id="new-box-form" onsubmit="createBox(event)">
                        <div class="form-group"><label>Cliente</label><select id="box-client-select" class="form-control" required onchange="loadClientOrdersInBox(this.value)"></select></div>
                        <div class="form-group"><label>Vincular Encomenda</label><select id="box-order-select" class="form-control" disabled onchange="autoFillBoxData(this)"><option value="">Selecione...</option></select></div>
                        <div class="form-group"><label>N√∫mero Box</label><input type="text" id="box-code" class="form-control" required></div>
                        <div class="form-group"><label>Produtos</label><textarea id="box-products" class="form-control" rows="3"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn" onclick="closeModal('modal-box')" style="background:#ccc; width:auto;">Cancelar</button>
                            <button type="submit" class="btn btn-primary" style="width:auto;">Criar</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <section id="billing-view" class="hidden">
            <div class="card" style="margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Status de Pagamentos</h3>
                    <button onclick="loadInvoices()" class="btn-secondary" style="width:auto;">üîÑ Atualizar Lista</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Cliente</th><th>Box Ref</th><th>Status</th><th>Verifica√ß√£o</th></tr></thead>
                    <tbody id="invoices-list"></tbody>
                </table>
            </div>
        </section>
<section id="labels-view" class="hidden">
    <div class="header-flex">
        <h2>üè∑Ô∏è Gerador de Etiquetas</h2>
        <div>
            <button onclick="printSelectedLabels()" class="btn btn-primary" style="background: #d4af37; color: #000; font-weight: bold;">
                <i class="fas fa-print"></i> Imprimir Selecionadas
            </button>
        </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <input type="text" id="label-search" onkeyup="filterLabels()" placeholder="Pesquisar por cliente ou c√≥digo..." class="form-control">
    </div>

    <div class="card">
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" onclick="toggleAllLabels(this)"></th>
                        <th>Data</th>
                        <th>C√≥digo</th>
                        <th>Cliente</th>
                        <th>Descri√ß√£o</th>
                        <th>Peso</th>
                    </tr>
                </thead>
                <tbody id="labels-list">
                    </tbody>
            </table>
        </div>
    </div>

</section>
        <section id="videos-section" class="hidden">
            <div class="card">
                <h3>üé• Nova Grava√ß√£o</h3>
                
                <div class="form-group">
                    <label>1. Selecione a Encomenda para vincular:</label>
                    <select id="video-client-select" class="form-control" onchange="checkVideoPermission()">
                        <option value="">Carregando lista...</option>
                    </select>
                </div>

                <div id="video-order-info" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <small>Resumo: <span id="info-desc" style="font-weight:bold;">-</span></small>
                </div>

                <button id="btn-open-fullscreen" onclick="openFullscreenCamera()" class="btn-primary" style="width: 100%; padding: 15px; font-size: 18px; background: #2c3e50;" disabled>
                    <i class="fas fa-camera"></i> ABRIR C√ÇMERA
                </button>
            </div>

            <div id="fullscreen-camera-overlay" class="hidden">
                <button onclick="closeFullscreenCamera()" style="position: absolute; top: 20px; right: 20px; z-index: 10001; background: none; border: none; color: white; font-size: 30px;">&times;</button>
                
                <video id="camera-feed" autoplay playsinline muted></video>
                <video id="video-preview" controls style="display: none;"></video>

                <div class="camera-floating-controls">
                    <div id="record-ui">
                        <p id="recording-timer" class="hidden">00:00</p>
                        <div style="display: flex; align-items: center; gap: 30px;">
                            <button onclick="switchCamera()" class="btn-icon">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="btn-start-rec" onclick="startRecording()" class="btn-record-circle"></button>
                            <button id="btn-stop-rec" onclick="stopRecording()" class="btn-stop-square hidden"></button>
                            <div style="width: 40px;"></div> 
                        </div>
                    </div>

                    <div id="upload-ui" class="hidden" style="width: 100%; padding: 20px;">
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="retakeVideo()" class="btn-secondary" style="background: white; color: black; border: none;">Descartar</button>
                            <button onclick="confirmUpload()" class="btn-primary" style="background: #28a745; border: none; flex: 1;">Enviar V√≠deo üöÄ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Hist√≥rico de V√≠deos</h3>
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Cliente</th><th>Data</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="admin-video-list"></tbody>
                </table>
            </div>
        </section>

        <section id="history-view" class="hidden">
            <div class="header-flex">
                <h2>üìú Hist√≥rico de Envios</h2>
                <input type="text" id="history-search" onkeyup="filterHistory()" placeholder="Filtrar por c√≥digo ou nome..." class="form-control" style="max-width: 300px; display: none;"> 
            </div>

            <div class="card-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>C√≥digo</th>
                            <th id="hist-col-client">Cliente</th> <th>Descri√ß√£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </section>

   <div id="scanner-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 500px; text-align: center;">
        <h3>üì± Leitor de Encomendas</h3>
        <p>Aponte a c√¢mera para o QR Code da etiqueta</p>
        
        <div id="reader" class="qr-scanner-container" style="width: 100%; border-radius: 8px; overflow: hidden; position: relative;">
            <div class="scanner-laser"></div>
        </div>

        <div class="modal-actions" style="justify-content: center; margin-top: 15px;">
            <button class="btn btn-secondary" onclick="stopScanner()">Fechar Leitor</button>
        </div>
    </div>
</div>

<div id="delivery-photo-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center; max-width: 400px;">
        <h3>üì∏ Comprovante de Entrega</h3>
        <p>Tire uma foto do pacote com o cliente.</p>
        
        <div style="position: relative; width: 100%; height: 250px; background: #000; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
            <video id="delivery-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            <canvas id="delivery-canvas" style="display:none;"></canvas>
            <img id="delivery-preview" style="display:none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
        </div>

        <div class="modal-actions" style="justify-content: center; gap: 10px;">
            <button class="btn btn-secondary" onclick="DeliveryProof.close()">Cancelar</button>
            <button id="btn-snap-photo" class="btn btn-primary" onclick="DeliveryProof.snap()">üì∑ Tirar Foto</button>
            <button id="btn-confirm-delivery" class="btn btn-success hidden" onclick="DeliveryProof.confirm()">‚úÖ Confirmar Entrega</button>
        </div>
    </div>
</div>

<div id="view-proof-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
    <div class="modal-content" style="background: transparent; box-shadow: none; text-align: center;">
        <img id="proof-image-full" src="" style="max-width: 100%; border-radius: 10px; border: 4px solid white;">
        <br>
        <button class="btn btn-secondary" style="margin-top: 10px;">Fechar</button>
    </div>
</div>
<div id="broadcast-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h3>üì¢ Enviar Comunicado em Massa</h3>
            <button class="btn-close" onclick="closeModal('broadcast-modal')">&times;</button>
        </div>
        <div class="modal-body">
            
            <div id="qr-container" style="text-align: center; display: none; margin-bottom: 15px;">
                <img id="zap-qr-img" style="width: 200px; border: 1px solid #ddd; border-radius: 8px;">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">Escaneie para conectar o WhatsApp</p>
            </div>

            <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <button onclick="getZapQR()" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">üîó Conectar WhatsApp</button>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="check-send-zap"> Enviar tamb√©m pelo Zap
                </label>
            </div>

            <div class="form-group">
                <label>Assunto (E-mail e T√≠tulo Zap)</label>
                <input type="text" id="broadcast-subject" class="form-control" placeholder="Ex: Aviso de Voo">
            </div>
            
            <div class="form-group">
                <label>Mensagem</label>
                <textarea id="broadcast-message" class="form-control" rows="5" placeholder="Escreva o comunicado aqui..."></textarea>
            </div>
            
            <button onclick="sendBroadcast()" class="btn btn-primary" style="width: 100%;">ENVIAR AGORA üöÄ</button>
        </div>
    </div>
</div>
<section id="finances-view" class="hidden">
    <div class="header-flex" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üí∞ Faturas Pagas e Pendentes</h2>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="exportFinancesPDF()" class="btn btn-primary" style="background: #e74c3c;"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
            <button onclick="exportFinancesExcel()" class="btn btn-primary" style="background: #27ae60;"><i class="fas fa-file-excel"></i> Abrir no Excel</button>
        </div>
    </div>

    <div class="card">
        <div style="margin: 15px 0; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #888;"></i>
            <input type="text" id="search-finances" onkeyup="searchTable('search-finances', 'finances-list')" 
                   placeholder="Buscar por c√≥digo, cliente ou status..." 
                   style="width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div class="table-responsive">
            <table class="data-table" id="finances-table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Tipo</th>
                        <th>Cliente</th>
                        <th>Descri√ß√£o</th>
                        <th style="text-align: center;">Peso</th>
                        <th style="text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody id="finances-list"></tbody>
            </table>
        </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { 
            initDashboard(); 
        });
    </script>
    <script src="cici.js"></script>
</body>
</html>